---
title: Oracleå®è·µæ•°æ®åº“ç¬”è®°-11
description: Oracleå®¡æ ¸çš„æ“ä½œï¼Œè§¦å‘å™¨çš„ä»£ç å®ç°ï¼Œä»¥åŠæ•°æ®ç§»åŠ¨çš„æ“ä½œ
categories:
  - è¯¾ç¨‹
tags:
  - Oracle
---
# Oracleå®è·µæ•°æ®åº“

## å®¡æ ¸

- **å¼ºåˆ¶å®¡æ ¸**
- **æ ‡å‡†æ•°æ®åº“å®¡æ ¸**
- **åŸºäºå€¼çš„å®¡æ ¸**
- **ç»†ç²’åº¦å®¡æ ¸(FGA)**

```sql
    desc dbms_fga;---STATEMENT_TYPESå®¡æ ¸è¯­å¥ç±»å‹
    execute dbms_fga.add_policy('SCOTT','EMP','FGA_DEMO',STATEMENT_TYPES=>'SELECT,INSERT,DELETE');
    ---æ‰§è¡Œselect,insert,deleteæ“ä½œ
    desc dba_fga_audit_trail
    alter session set nls_date_format='yyyy-mm-dd hh24:mi:ss';
    ---ä¸­é—´è¿›è¡Œscottç”¨æˆ·ä¸‹çš„select,insertå’Œdeleteæ“ä½œ
    select TIMESTAMP,DB_USER,SQL_TEXT from dba_fga_audit_trail
```

- **å®¡æ ¸DBA**

```sql
    show parameter audit
```

## è§¦å‘å™¨(å¤´éƒ¨,è§¦å‘æ¡ä»¶,è¢«è§¦å‘ä»£ç )

- **DMLè§¦å‘å™¨**

  æ·»åŠ for each rowè¿›è¡Œé€è¡Œæ“ä½œæ˜¾ç¤º

  æ·»åŠ referencing old as o new as n for each row when(n.sal>5000)è¿›è¡Œæ¡ä»¶

```sql
    create table demo1(a varchar(20));
    create or replace trigger scott.tr1
    after update on scott.emp for each row
    begin
    	insert into scott.demo1 values('changed!');
    end;
    update emp set sal=2000 where empno=7369;
    select * from demo1;
    create or replace trigger scott.tr1
    after update on scott.emp referencing old as o new as n for each row when(n.sal>5000)
    begin
    	insert into scott.demo1 values('changed!');
    end;
```

**åˆ›å»ºä¸€ä¸ªå·¥èµ„è¡¨, ç”¨è§¦å‘å™¨å®ç°æ›´æ”¹å·¥èµ„ä¹‹å, æ˜¾ç¤ºæ—§çš„å·¥èµ„å’Œæ–°çš„å·¥èµ„çš„å˜åŒ–**ğŸ†—

```sql
    create table sal_change(empno number(4),ename varchar2(10), old_sal number(7,2), new_sal number(7,2));
    create or replace trigger scott.tr1
    after update on scott.emp referencing old as o new as n for each row
    begin
      insert into scott.sal_change values(:o.empno, :o.ename,:o.sal,:n.sal);
    end;
    update emp set sal=4000 where empno=7902;
    select * from sal_change;
```

- **ç³»ç»Ÿè§¦å‘å™¨**

    **å¦‚ç”¨æ¥è®°å½•ç”¨æˆ·çš„ç™»é™†æƒ…å†µ**

    ```sql
    login_rec +++(username,login_time)
    create or replace trigger scott.tr1
    after logon on database
    begin
    	insert into login_rec values ();
    end;---scottæƒé™ä¸è¶³å¾—æ¢ç”¨æˆ·
    alter session set nls_data_format='yyyy-mm-dd hh24:mi:ss';
    desc dbms_shared_pool;---å…±äº«æ± 
    desc v$db_object_cache;---å†…å­˜ä¸­çš„ä¸œè¥¿
    select owner,name,type from v$db_object_cache
    where owner<>'SYS' and kept='YES';---æŸ¥è¯¢å†…å­˜ä¸­çš„å†…å­˜
    desc user_procedures;
    select object_name,object_type from user_procedures
    where object_type ='PROCEDURE';---æŸ¥è¯¢å­˜å‚¨è¿‡ç¨‹
    execute dbms_shared_pool.keep('scott.p20');---ä¿æŒp20è¿™ä¸ªå­˜å‚¨è¿‡ç¨‹
    select object_name,object_type from user_procedures
    where object_type ='procedure';
    ```

    **åˆ›å»ºä¸€ä¸ªstartupçš„è§¦å‘å™¨**

    ```sql
    create or replace procedure scott.p20
    as
    begin
    null;
    end;
    /
    select owner,name,type from v$db_object_cache
    where owner<>'SYS' and kept='YES';---æŸ¥è¯¢ä¸€ä¸‹å†…å­˜ä¸­æ˜¯å¦å­˜åœ¨ N
    execute dbms_shared_pool.keep('scott.p20');
    select owner,name,type from v$db_object_cache
    where owner<>'SYS' and kept='YES';---æŸ¥è¯¢ä¸€ä¸‹å†…å­˜ä¸­æ˜¯å¦å­˜åœ¨ Y
    ---ç»è¿‡shutdownå’Œstartupä¹‹å,p20åœ¨å†…å­˜ä¸­ä¸ä¼šå­˜åœ¨äº†
    ---å¦‚æœé‡è§shutdownå’Œstartupä¹‹å,æ“ä½œæŠ¥é”™å°±å†æ“ä½œä¸€é
    shutdown immediate
    startup
    ---å¦‚æœæ˜¯scott.tr2å°±æ˜¯åœ¨scottä¸‹è¿›è¡Œkeepæ“ä½œå°±éœ€è¦grantæƒé™
    create or replace trigger tr2
    after startup on database
    begin
    	sys.dbms_shared_pool.keep('scott.p20');
    end;
    shutdown immediate
    startup
    select owner,name,type from v$db_object_cache
    where owner<>'SYS' and kept='YES';---æœ‰äº†
    ```

## ç§»åŠ¨æ•°æ®

- **æ•°æ®æ–‡ä»¶â€”>æ•°æ®åº“**
  - **cmdä¸‹sqlldr**
  - **cmdä¸‹exp/imp (exportå’Œimport)**

    ```sql
      æŸ¥è¯¢expå’Œimpçš„å‚æ•°
      CMD>exp help=y
      
      å¯¼å‡ºå·¥èµ„åœ¨2500ä»¥ä¸Šçš„empè¡¨ä¸­çš„æ•°æ®---cmdä¸­
      CMD>exp scott/tiger file=d:\demo1.dmp tables=emp query='where sal>2500'
      æŠ¥é”™ LRM-00111: å€¼ 'where sal' ç¼ºå°‘å³å¼•å·
      æ˜¯å› ä¸º>æ˜¯ç®¡é“å‘½ä»¤,è¾“å‡ºçš„æ„æ€. å› æ­¤ä¼šåœ¨å½“å‰cmdç›®å½•ä¸‹äº§ç”Ÿä¸€ä¸ªåä¸º"2500'"çš„æ–‡ä»¶
      å› æ­¤è¦å±è”½å¤§äºå·
      CMD>exp scott/tiger file=d:\demo1.dmp tables=emp query='where "sal>2500"'
      æˆ–è€…åœ¨>SQLä¸­åŠ ä¸Š$è·‘
      SQL>$exp scott/tiger file=d:\demo1.dmp tables=emp query='where "sal>2500"'
      
      å­—ç¬¦é›†é—®é¢˜ 16è¿›åˆ¶->354å¯¹åº”å­—ç¬¦é›†id->852,æŸ¥è¯¢ä¸ºZHS16GBK
      select nls_charset_name(852) from dual;
      æ›´æ”¹å­—ç¬¦é›†ä¸ºWE8ISO8859P1,æŸ¥è¯¢è¯¥idå¾—åˆ°ä¸º31,è½¬ä¸º16è¿›åˆ¶->1F
      select nls_charset_id('WE8ISO8859P1') from dual;
    ```

  ![æ•ˆæœå›¾](https://static.notion-static.com/801127da-7c3c-439e-8c98-4e9aa6330129/Untitled)

  ![æ•ˆæœå›¾](https://static.notion-static.com/bb819c5c-0092-4d36-89f5-2a5a7609e4e6/Untitled)

  - **expdp/impdp æ•°æ®æ³µ, å¹¶è¡Œ(å¤§ä»»åŠ¡, è¶³å¤Ÿå¤šçš„ç©ºé—²èµ„æº)**

    ```sql
      CMD>expdp scott/tiger file=d:\demo2.dmp tables=emp
      æŠ¥é”™:
      ORA-39001: å‚æ•°å€¼æ— æ•ˆ
      ORA-39000: è½¬å‚¨æ–‡ä»¶è¯´æ˜é”™è¯¯
      ORA-39088: æ–‡ä»¶åä¸èƒ½åŒ…å«è·¯å¾„è¯´æ˜
      SQL>create directory sha as 'd:\dxp' åªæ˜¯åœ¨æ•°æ®åº“ä¸­å£°æ˜,å®é™…ç›®å½•éœ€è¦åœ¨æ–‡ä»¶ä¸­åˆ›å»ºå¥½
      SQL>grant read,write on directory sha to scott;
      CMD>expdp scott/tiger directory=sha file=demo2.dmp tables=emp
      SQL>conn scott/tiger
      SQL>drop table emp;
      CMD>impdp scott/tiger directory=sha file=demo2.dmp tables=emp
    ```

  ![4](https://static.notion-static.com/2b622c7a-1bf2-4fe6-b312-3553fc69ab74/Untitled)

  ![5](https://static.notion-static.com/f5f13bc0-df35-459a-a931-6d09a4ea7682/Untitled)

- **æ•°æ®åº“<â€”>æ•°æ®åº“**
- **æ•°æ®åº“â€”>æ•°æ®æ–‡ä»¶**